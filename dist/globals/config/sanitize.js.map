{"version":3,"sources":["../../../src/globals/config/sanitize.ts"],"sourcesContent":["// @ts-strict-ignore\nimport type { Config, SanitizedConfig } from '../../config/types.js'\nimport type { GlobalConfig, SanitizedGlobalConfig } from './types.js'\n\nimport defaultAccess from '../../auth/defaultAccess.js'\nimport { sanitizeFields } from '../../fields/config/sanitize.js'\nimport { fieldAffectsData } from '../../fields/config/types.js'\nimport mergeBaseFields from '../../fields/mergeBaseFields.js'\nimport { flattenAllFields } from '../../utilities/flattenAllFields.js'\nimport { toWords } from '../../utilities/formatLabels.js'\nimport baseVersionFields from '../../versions/baseFields.js'\nimport { versionDefaults } from '../../versions/defaults.js'\nimport { defaultGlobalEndpoints } from '../endpoints/index.js'\n\nexport const sanitizeGlobal = async (\n  config: Config,\n  global: GlobalConfig,\n  /**\n   * If this property is set, RichText fields won't be sanitized immediately. Instead, they will be added to this array as promises\n   * so that you can sanitize them together, after the config has been sanitized.\n   */\n  richTextSanitizationPromises?: Array<(config: SanitizedConfig) => Promise<void>>,\n  _validRelationships?: string[],\n): Promise<SanitizedGlobalConfig> => {\n  if (global._sanitized) {\n    return global as SanitizedGlobalConfig\n  }\n  global._sanitized = true\n\n  global.label = global.label || toWords(global.slug)\n\n  // /////////////////////////////////\n  // Ensure that collection has required object structure\n  // /////////////////////////////////\n\n  global.endpoints = global.endpoints ?? []\n  if (!global.hooks) {\n    global.hooks = {}\n  }\n  if (!global.access) {\n    global.access = {}\n  }\n  if (!global.admin) {\n    global.admin = {}\n  }\n\n  if (!global.access.read) {\n    global.access.read = defaultAccess\n  }\n  if (!global.access.update) {\n    global.access.update = defaultAccess\n  }\n\n  if (!global.hooks.beforeValidate) {\n    global.hooks.beforeValidate = []\n  }\n  if (!global.hooks.beforeChange) {\n    global.hooks.beforeChange = []\n  }\n  if (!global.hooks.afterChange) {\n    global.hooks.afterChange = []\n  }\n  if (!global.hooks.beforeRead) {\n    global.hooks.beforeRead = []\n  }\n  if (!global.hooks.afterRead) {\n    global.hooks.afterRead = []\n  }\n\n  // Sanitize fields\n  const validRelationships = _validRelationships ?? config.collections.map((c) => c.slug) ?? []\n\n  global.fields = await sanitizeFields({\n    config,\n    fields: global.fields,\n    parentIsLocalized: false,\n    richTextSanitizationPromises,\n    validRelationships,\n  })\n\n  if (global.endpoints !== false) {\n    if (!global.endpoints) {\n      global.endpoints = []\n    }\n\n    for (const endpoint of defaultGlobalEndpoints) {\n      global.endpoints.push(endpoint)\n    }\n  }\n\n  if (global.versions) {\n    if (global.versions === true) {\n      global.versions = { drafts: false, max: 100 }\n    }\n\n    global.versions.max = typeof global.versions.max === 'number' ? global.versions.max : 100\n\n    if (global.versions.drafts) {\n      if (global.versions.drafts === true) {\n        global.versions.drafts = {\n          autosave: false,\n          validate: false,\n        }\n      }\n\n      if (global.versions.drafts.autosave === true) {\n        global.versions.drafts.autosave = {\n          interval: versionDefaults.autosaveInterval,\n        }\n      }\n\n      if (global.versions.drafts.validate === undefined) {\n        global.versions.drafts.validate = false\n      }\n\n      global.fields = mergeBaseFields(global.fields, baseVersionFields)\n    }\n  }\n\n  if (!global.custom) {\n    global.custom = {}\n  }\n\n  // /////////////////////////////////\n  // Sanitize fields\n  // /////////////////////////////////\n  let hasUpdatedAt = null\n  let hasCreatedAt = null\n  global.fields.some((field) => {\n    if (fieldAffectsData(field)) {\n      if (field.name === 'updatedAt') {\n        hasUpdatedAt = true\n      }\n      if (field.name === 'createdAt') {\n        hasCreatedAt = true\n      }\n    }\n    return hasCreatedAt && hasUpdatedAt\n  })\n  if (!hasUpdatedAt) {\n    global.fields.push({\n      name: 'updatedAt',\n      type: 'date',\n      admin: {\n        disableBulkEdit: true,\n        hidden: true,\n      },\n      label: ({ t }) => t('general:updatedAt'),\n    })\n  }\n  if (!hasCreatedAt) {\n    global.fields.push({\n      name: 'createdAt',\n      type: 'date',\n      admin: {\n        disableBulkEdit: true,\n        hidden: true,\n      },\n      label: ({ t }) => t('general:createdAt'),\n    })\n  }\n\n  ;(global as SanitizedGlobalConfig).flattenedFields = flattenAllFields({ fields: global.fields })\n\n  return global as SanitizedGlobalConfig\n}\n"],"names":["defaultAccess","sanitizeFields","fieldAffectsData","mergeBaseFields","flattenAllFields","toWords","baseVersionFields","versionDefaults","defaultGlobalEndpoints","sanitizeGlobal","config","global","richTextSanitizationPromises","_validRelationships","_sanitized","label","slug","endpoints","hooks","access","admin","read","update","beforeValidate","beforeChange","afterChange","beforeRead","afterRead","validRelationships","collections","map","c","fields","parentIsLocalized","endpoint","push","versions","drafts","max","autosave","validate","interval","autosaveInterval","undefined","custom","hasUpdatedAt","hasCreatedAt","some","field","name","type","disableBulkEdit","hidden","t","flattenedFields"],"mappings":"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"}