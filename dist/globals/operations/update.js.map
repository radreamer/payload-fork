{"version":3,"sources":["../../../src/globals/operations/update.ts"],"sourcesContent":["// @ts-strict-ignore\nimport type { DeepPartial } from 'ts-essentials'\n\nimport type { GlobalSlug, JsonObject } from '../../index.js'\nimport type {\n  Operation,\n  PayloadRequest,\n  PopulateType,\n  SelectType,\n  TransformGlobalWithSelect,\n  Where,\n} from '../../types/index.js'\nimport type {\n  DataFromGlobalSlug,\n  SanitizedGlobalConfig,\n  SelectFromGlobalSlug,\n} from '../config/types.js'\n\nimport executeAccess from '../../auth/executeAccess.js'\nimport { afterChange } from '../../fields/hooks/afterChange/index.js'\nimport { afterRead } from '../../fields/hooks/afterRead/index.js'\nimport { beforeChange } from '../../fields/hooks/beforeChange/index.js'\nimport { beforeValidate } from '../../fields/hooks/beforeValidate/index.js'\nimport { deepCopyObjectSimple } from '../../index.js'\nimport { checkDocumentLockStatus } from '../../utilities/checkDocumentLockStatus.js'\nimport { commitTransaction } from '../../utilities/commitTransaction.js'\nimport { getSelectMode } from '../../utilities/getSelectMode.js'\nimport { initTransaction } from '../../utilities/initTransaction.js'\nimport { killTransaction } from '../../utilities/killTransaction.js'\nimport { sanitizeSelect } from '../../utilities/sanitizeSelect.js'\nimport { getLatestGlobalVersion } from '../../versions/getLatestGlobalVersion.js'\nimport { saveVersion } from '../../versions/saveVersion.js'\n\ntype Args<TSlug extends GlobalSlug> = {\n  autosave?: boolean\n  data: DeepPartial<Omit<DataFromGlobalSlug<TSlug>, 'id'>>\n  depth?: number\n  disableTransaction?: boolean\n  draft?: boolean\n  globalConfig: SanitizedGlobalConfig\n  overrideAccess?: boolean\n  overrideLock?: boolean\n  populate?: PopulateType\n  publishSpecificLocale?: string\n  req: PayloadRequest\n  select?: SelectType\n  showHiddenFields?: boolean\n  slug: string\n}\n\nexport const updateOperation = async <\n  TSlug extends GlobalSlug,\n  TSelect extends SelectFromGlobalSlug<TSlug>,\n>(\n  args: Args<TSlug>,\n): Promise<TransformGlobalWithSelect<TSlug, TSelect>> => {\n  if (args.publishSpecificLocale) {\n    args.req.locale = args.publishSpecificLocale\n  }\n\n  const {\n    slug,\n    autosave,\n    depth,\n    disableTransaction,\n    draft: draftArg,\n    globalConfig,\n    overrideAccess,\n    overrideLock,\n    populate,\n    publishSpecificLocale,\n    req: { fallbackLocale, locale, payload },\n    req,\n    select: incomingSelect,\n    showHiddenFields,\n  } = args\n\n  try {\n    const shouldCommit = !disableTransaction && (await initTransaction(req))\n\n    let { data } = args\n\n    const shouldSaveDraft = Boolean(draftArg && globalConfig.versions?.drafts)\n\n    // /////////////////////////////////////\n    // 1. Retrieve and execute access\n    // /////////////////////////////////////\n\n    const accessResults = !overrideAccess\n      ? await executeAccess(\n          {\n            data,\n            req,\n          },\n          globalConfig.access.update,\n        )\n      : true\n\n    // /////////////////////////////////////\n    // Retrieve document\n    // /////////////////////////////////////\n\n    const query: Where = overrideAccess ? undefined : (accessResults as Where)\n\n    // /////////////////////////////////////\n    // 2. Retrieve document\n    // /////////////////////////////////////\n    const globalVersion = await getLatestGlobalVersion({\n      slug,\n      config: globalConfig,\n      locale,\n      payload,\n      req,\n      where: query,\n    })\n    const { global, globalExists } = globalVersion || {}\n\n    let globalJSON: JsonObject = {}\n\n    if (globalVersion && globalVersion.global) {\n      globalJSON = deepCopyObjectSimple(global)\n\n      if (globalJSON._id) {\n        delete globalJSON._id\n      }\n    }\n\n    const originalDoc = await afterRead({\n      collection: null,\n      context: req.context,\n      depth: 0,\n      doc: deepCopyObjectSimple(globalJSON),\n      draft: draftArg,\n      fallbackLocale,\n      global: globalConfig,\n      locale,\n      overrideAccess: true,\n      req,\n      showHiddenFields,\n    })\n\n    // ///////////////////////////////////////////\n    // Handle potentially locked global documents\n    // ///////////////////////////////////////////\n\n    await checkDocumentLockStatus({\n      globalSlug: slug,\n      lockErrorMessage: `Global with slug \"${slug}\" is currently locked by another user and cannot be updated.`,\n      overrideLock,\n      req,\n    })\n\n    // /////////////////////////////////////\n    // beforeValidate - Fields\n    // /////////////////////////////////////\n\n    data = await beforeValidate({\n      collection: null,\n      context: req.context,\n      data,\n      doc: originalDoc,\n      global: globalConfig,\n      operation: 'update',\n      overrideAccess,\n      req,\n    })\n\n    // /////////////////////////////////////\n    // beforeValidate - Global\n    // /////////////////////////////////////\n\n    if (globalConfig.hooks?.beforeValidate?.length) {\n      for (const hook of globalConfig.hooks.beforeValidate) {\n        data =\n          (await hook({\n            context: req.context,\n            data,\n            global: globalConfig,\n            originalDoc,\n            req,\n          })) || data\n      }\n    }\n\n    // /////////////////////////////////////\n    // beforeChange - Global\n    // /////////////////////////////////////\n\n    if (globalConfig.hooks?.beforeChange?.length) {\n      for (const hook of globalConfig.hooks.beforeChange) {\n        data =\n          (await hook({\n            context: req.context,\n            data,\n            global: globalConfig,\n            originalDoc,\n            req,\n          })) || data\n      }\n    }\n\n    // /////////////////////////////////////\n    // beforeChange - Fields\n    // /////////////////////////////////////\n    let publishedDocWithLocales = globalJSON\n    let versionSnapshotResult\n\n    const beforeChangeArgs = {\n      collection: null,\n      context: req.context,\n      data,\n      doc: originalDoc,\n      docWithLocales: undefined,\n      global: globalConfig,\n      operation: 'update' as Operation,\n      req,\n      skipValidation:\n        shouldSaveDraft && globalConfig.versions.drafts && !globalConfig.versions.drafts.validate,\n    }\n\n    if (publishSpecificLocale) {\n      const latestVersion = await getLatestGlobalVersion({\n        slug,\n        config: globalConfig,\n        payload,\n        published: true,\n        req,\n        where: query,\n      })\n\n      publishedDocWithLocales = latestVersion?.global || {}\n\n      versionSnapshotResult = await beforeChange({\n        ...beforeChangeArgs,\n        docWithLocales: globalJSON,\n      })\n    }\n\n    let result = await beforeChange({\n      ...beforeChangeArgs,\n      docWithLocales: publishedDocWithLocales,\n    })\n\n    // /////////////////////////////////////\n    // Update\n    // /////////////////////////////////////\n\n    const select = sanitizeSelect({\n      fields: globalConfig.flattenedFields,\n      forceSelect: globalConfig.forceSelect,\n      select: incomingSelect,\n    })\n\n    if (!shouldSaveDraft) {\n      // Ensure global has createdAt\n      if (!result.createdAt) {\n        result.createdAt = new Date().toISOString()\n      }\n\n      if (globalExists) {\n        result = await payload.db.updateGlobal({\n          slug,\n          data: result,\n          req,\n          select,\n        })\n      } else {\n        result = await payload.db.createGlobal({\n          slug,\n          data: result,\n          req,\n        })\n      }\n    }\n\n    // /////////////////////////////////////\n    // Create version\n    // /////////////////////////////////////\n    if (globalConfig.versions) {\n      const { globalType } = result\n      result = await saveVersion({\n        autosave,\n        docWithLocales: result,\n        draft: shouldSaveDraft,\n        global: globalConfig,\n        payload,\n        publishSpecificLocale,\n        req,\n        select,\n        snapshot: versionSnapshotResult,\n      })\n\n      result = {\n        ...result,\n        globalType,\n      }\n    }\n\n    // /////////////////////////////////////\n    // Execute globalType field if not selected\n    // /////////////////////////////////////\n    if (select && result.globalType) {\n      const selectMode = getSelectMode(select)\n      if (\n        (selectMode === 'include' && !select['globalType']) ||\n        (selectMode === 'exclude' && select['globalType'] === false)\n      ) {\n        delete result['globalType']\n      }\n    }\n\n    // /////////////////////////////////////\n    // afterRead - Fields\n    // /////////////////////////////////////\n\n    result = await afterRead({\n      collection: null,\n      context: req.context,\n      depth,\n      doc: result,\n      draft: draftArg,\n      fallbackLocale: null,\n      global: globalConfig,\n      locale,\n      overrideAccess,\n      populate,\n      req,\n      select,\n      showHiddenFields,\n    })\n\n    // /////////////////////////////////////\n    // afterRead - Global\n    // /////////////////////////////////////\n\n    if (globalConfig.hooks?.afterRead?.length) {\n      for (const hook of globalConfig.hooks.afterRead) {\n        result =\n          (await hook({\n            context: req.context,\n            doc: result,\n            global: globalConfig,\n            req,\n          })) || result\n      }\n    }\n\n    // /////////////////////////////////////\n    // afterChange - Fields\n    // /////////////////////////////////////\n\n    result = await afterChange({\n      collection: null,\n      context: req.context,\n      data,\n      doc: result,\n      global: globalConfig,\n      operation: 'update',\n      previousDoc: originalDoc,\n      req,\n    })\n\n    // /////////////////////////////////////\n    // afterChange - Global\n    // /////////////////////////////////////\n\n    if (globalConfig.hooks?.afterChange?.length) {\n      for (const hook of globalConfig.hooks.afterChange) {\n        result =\n          (await hook({\n            context: req.context,\n            doc: result,\n            global: globalConfig,\n            previousDoc: originalDoc,\n            req,\n          })) || result\n      }\n    }\n\n    // /////////////////////////////////////\n    // Return results\n    // /////////////////////////////////////\n\n    if (shouldCommit) {\n      await commitTransaction(req)\n    }\n\n    return result as TransformGlobalWithSelect<TSlug, TSelect>\n  } catch (error: unknown) {\n    await killTransaction(req)\n    throw error\n  }\n}\n"],"names":["executeAccess","afterChange","afterRead","beforeChange","beforeValidate","deepCopyObjectSimple","checkDocumentLockStatus","commitTransaction","getSelectMode","initTransaction","killTransaction","sanitizeSelect","getLatestGlobalVersion","saveVersion","updateOperation","args","publishSpecificLocale","req","locale","slug","autosave","depth","disableTransaction","draft","draftArg","globalConfig","overrideAccess","overrideLock","populate","fallbackLocale","payload","select","incomingSelect","showHiddenFields","shouldCommit","data","shouldSaveDraft","Boolean","versions","drafts","accessResults","access","update","query","undefined","globalVersion","config","where","global","globalExists","globalJSON","_id","originalDoc","collection","context","doc","globalSlug","lockErrorMessage","operation","hooks","length","hook","publishedDocWithLocales","versionSnapshotResult","beforeChangeArgs","docWithLocales","skipValidation","validate","latestVersion","published","result","fields","flattenedFields","forceSelect","createdAt","Date","toISOString","db","updateGlobal","createGlobal","globalType","snapshot","selectMode","previousDoc","error"],"mappings":"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"}